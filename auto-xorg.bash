#!/bin/bash

#
# Author:       Alex Portell <https://github.com/portellam>
# Description:  Generates Xorg (video output) for the first or last valid non-VFIO video (VGA) device.
#

# check if sudo/root #
    if [[ $(whoami) != *"root"* ]]; then
        str_file1=$(echo ${0##/*})
        str_file1=$(echo $str_file1 | cut -d '/' -f2)
        echo -e "WARNING: Script must execute as root. In terminal, run:\n\t'sudo bash $str_file1'\n\tor\n\t'su' and 'bash $str_file1'.\nExiting."
        exit 1
    fi

# set IFS #
    SAVEIFS=$IFS   # Save current IFS (Internal Field Separator)
    IFS=$'\n'      # Change IFS to newline char

# parameters #
    bool_parseFirstVGA=true
    str_input1=$(echo $1 | tr '[:upper:]' '[:lower:]')
    str_outDir1='/etc/X11/xorg.conf.d/'
    str_outFile1=${str_outDir1}'10-auto-xorg.conf'

# match input vars
    case $str_input1 in
        "y")
            bool_parseFirstVGA=true;;

        "n")
            bool_parseFirstVGA=false
            echo -e "NOTE: Parsing VGA devices in reverse order.";;

        *)
            echo -e "FAILURE: Invalid input. Missing input variable [Y/n]. Exiting."
            exit 1;;
    esac

# parse PCI #
    if [[ $bool_parseFirstVGA == true ]]; then
        declare -a arr_PCI_ID=$(lspci -m | grep -E 'VGA|Graphics' | cut -d ' ' -f1)

    else
        declare -a arr_PCI_ID=$(lspci -m | grep -E 'VGA|Graphics' | cut -d ' ' -f1 | sort -r)
    fi

# clear existing file #
    if [[ -e $str_outFile1 ]]; then
        rm $str_outFile1
    fi

# find first/last valid VGA driver #
    for str_thisPCI_ID in ${arr_PCI_ID}; do

        # parameters #
        str_thisDriver=$(lspci -ks $str_thisPCI_ID | grep -E 'driver' | cut -d ':' -f2 | cut -d ' ' -f2)
        str_thisType=$(lspci -ms $str_thisPCI_ID | cut -d '"' -f2 | tr '[:upper:]' '[:lower:]')
        str_thisVendor=$(lspci -ms $str_thisPCI_ID | cut -d '"' -f4 | tr '[:upper:]' '[:lower:]')
        # str_thisBusID=$(echo $str_thisPCI_ID | cut -d ':' -f1)
        # str_thisSlotID=$(echo $str_thisPCI_ID | cut -d ':' -f2 | cut -d '.' -f1)
        str_thisFuncID=$(echo $str_thisPCI_ID | cut -d '.' -f2)
        str_thisPCI_ID=$(echo $str_thisPCI_ID | cut -d '.' -f1)

        # rearrange string for Xorg output #
        # str_thisPCI_ID=${str_thisBusID}":"${str_thisSlotID}":"${str_thisFuncID}
        str_thisPCI_ID+=":"${str_thisFuncID}

        echo -e "Found PCI ID: '$str_thisPCI_ID'"

        # match valid VGA device and driver #
        if [[ ($str_thisType == *"vga"* || $str_thisType == *"graphics" ) && ( -e $str_thisDriver || $str_thisDriver != "" ) && $str_thisDriver != *"vfio-pci"* ]]; then

            echo -e "Found Driver: '$str_thisDriver'"

            if [[ $str_thisVendor == "*intel"* ]]; then
                echo -e "WARNING: Should given parsed Intel VGA driver be invalid, replace xorg.conf with an alternate intel driver (example: 'modesetting')."
            fi

            readonly str_thisPCI_ID
            readonly str_thisDriver
            break

        elif [[ $str_thisDriver == "" ]]; then
            echo -e "Found Driver: 'N/A'"

        else
            echo -e "Found Driver: '$str_thisDriver'"
        fi
    done

# write to file #
    if [[ -e $str_outDir1 ]]; then

        # valid xorg #
        if [[ $str_thisDriver != "" ]]; then
            echo -e "Valid VGA device found."

            declare -a arr_output1=(
"# Generated by 'portellam/Auto-Xorg'
#
# WARNING: Any modifications to this file will be modified by 'Auto-Xorg'
#
# Execute \"lspci -k\" for Bus ID and Driver.
#
\nSection\t\"Device\"
\tIdentifier\t\"Device0\"
\tDriver\t\t\"$str_thisDriver\"
\tBusID\t\t\"PCI:$str_thisPCI_ID\"
EndSection")

            # append file #
            for str_line1 in ${arr_output1[@]}; do
                echo -e $str_line1 >> $str_outFile1
            done

        # template #
        else
            echo -e "WARNING: No valid VGA device found. Continuing."

            declare -a arr_output1=(
"# Generated by 'portellam/Auto-Xorg'
#
# WARNING: Any modifications to this file will be modified by 'Auto-Xorg'
#
# Execute 'lspci -k' for Bus ID and Driver.
#
\n#Section\t\"Device\"
#\tIdentifier\t\"Device0\"
#\tDriver\t\t\"driver_name\"
#\tBusID\t\t\"PCI:x:x:x\"
#EndSection")

            # append file #
            for str_line1 in ${arr_output1[@]}; do
                echo -e $str_line1 >> $str_outFile1
            done
        fi

# missing files #
    else
        echo -e "FAILURE: Missing directories/files:"

        if [[ -z $str_outDir1 ]]; then
            echo -e "\t$str_outDir1"
        fi

        if [[ -z $str_outDir1$str_outFile1 ]]; then
            echo -e "\t$str_outDir1$str_outFile1"
        fi

        echo -e "Exiting."
        exit 1
    fi

IFS=$SAVEIFS   # Restore original IFS
exit 0